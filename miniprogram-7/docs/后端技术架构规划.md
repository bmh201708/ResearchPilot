# Research Pilot 后端技术架构规划（V1）

## 1. 目标与约束
- 目标：在现有微信小程序前端基础上，快速落地稳定可扩展的后端。
- 约束：
  - 使用你现有腾讯云服务器（`111.229.204.242`）。
  - PostgreSQL 使用 Docker 部署在云服务器。
  - 小程序端通过 HTTPS 调用后端 API。

## 2. 架构选型结论
- 后端形态：自建后端服务（非纯微信云开发）。
- 数据库：PostgreSQL（Docker 容器）。
- 缓存与异步任务：Redis + 队列（推荐，支持 AI 异步任务和限流）。
- 部署方式：Docker Compose 管理 `api + postgres + redis + nginx`。

## 3. 总体架构图
```text
WeChat Mini Program
        |
        | HTTPS (JWT)
        v
     Nginx (TLS / reverse proxy)
        |
        v
  Backend API (Node.js/NestJS)
   |        |          |
   |        |          +--> LLM Provider API (总结/润色/模拟审稿)
   |        |
   |        +--> Redis (cache, queue, rate limit)
   |
   +--> PostgreSQL (users/papers/tasks/comments/metrics)

Scheduled Worker (Cron):
- 每日抓取 arXiv
- 会议DDL同步
- AI摘要预生成
```

## 4. 技术栈建议
- 运行时：Node.js 20 LTS
- 服务框架：NestJS（模块化清晰，适合多人协作）
- ORM：Prisma（迁移和类型安全较友好）
- 数据库：PostgreSQL 16
- 缓存/队列：Redis 7 + BullMQ
- 网关：Nginx（HTTPS、限流、转发）
- 进程与容器：Docker + Docker Compose
- 日志：Pino（JSON 日志）

## 5. 后端模块划分
- `auth`：微信登录、JWT签发、用户会话
- `user`：用户信息、研究偏好（CV/NLP/会议偏好）
- `paper`：论文列表、详情、收藏/Pass、评论
- `ai`：三行总结、润色、Rebuttal 模拟
- `mission`：会议DDL、倒排任务、任务状态
- `profile`：仪表盘统计、成就徽章
- `admin`（可选）：评论审核、敏感词、API调用监控

## 6. 关键业务流程

### 6.1 微信登录流程
1. 小程序调用 `wx.login()` 获取 `code`。
2. 后端 `POST /auth/wx-login`，用 `code2session` 换取 `openid`。
3. 后端按 `openid` 创建/更新用户并签发 JWT。
4. 小程序后续请求携带 `Authorization: Bearer <token>`。

### 6.2 每日论文流（Paper Flow）
1. 定时任务每天抓取 arXiv（按主题分类）。
2. 入库 `papers`，并触发 AI 生成三行总结。
3. 用户请求推荐流时，按偏好和去重策略返回。
4. 用户左滑/右滑写入 `user_paper_actions`。

### 6.3 AI Lab
1. 用户提交文本到 `ai` 模块。
2. 后端校验长度、做频控，写入 `ai_jobs`。
3. 异步调用大模型，结果回填数据库并返回任务状态。

## 7. 数据库模型（V1）

### 7.1 核心表
- `users`
  - `id`、`openid`(unique)、`nickname`、`avatar_url`、`created_at`
- `user_preferences`
  - `user_id`、`domains`(JSONB)、`target_conferences`(JSONB)
- `papers`
  - `id`、`arxiv_id`(unique)、`title`、`authors`(JSONB)、`abstract`、`published_at`、`tags`(JSONB)
- `paper_summaries`
  - `paper_id`、`summary_bg`、`summary_method`、`summary_contrib`、`model_name`
- `user_paper_actions`
  - `user_id`、`paper_id`、`action`(PASS/MARK/READ)、`created_at`
- `comments`
  - `id`、`paper_id`、`user_id`、`content`、`status`(VISIBLE/HIDDEN/REVIEW)、`created_at`
- `conferences`
  - `id`、`name`、`year`、`abstract_deadline`、`paper_deadline`、`timezone`
- `missions`
  - `id`、`user_id`、`conference_id`、`title`、`deadline`
- `tasks`
  - `id`、`mission_id`、`title`、`due_at`、`status`(TODO/DOING/DONE)
- `ai_jobs`
  - `id`、`user_id`、`job_type`、`input_text`、`status`、`result`(JSONB)、`error_message`
- `user_badges`
  - `id`、`user_id`、`badge_code`、`unlocked_at`

### 7.2 关键索引
- `users(openid)`
- `papers(arxiv_id, published_at)`
- `user_paper_actions(user_id, created_at)`
- `comments(paper_id, created_at)`
- `tasks(mission_id, due_at)`

## 8. API 设计（MVP）
- 认证
  - `POST /auth/wx-login`
- 用户
  - `GET /users/me`
  - `PUT /users/preferences`
- 论文
  - `GET /papers/feed`
  - `GET /papers/:id`
  - `POST /papers/:id/action`（PASS/MARK）
  - `GET /papers/:id/comments`
  - `POST /papers/:id/comments`
- AI
  - `POST /ai/summary`
  - `POST /ai/polish`
  - `POST /ai/rebuttal`
  - `GET /ai/jobs/:id`
- 项目管理
  - `GET /conferences`
  - `POST /missions`
  - `GET /missions/:id/tasks`
  - `PATCH /tasks/:id`
- 个人中心
  - `GET /profile/dashboard`
  - `GET /profile/library`

## 9. 云服务器部署规划

### 9.1 容器组成
- `nginx`：80/443，对外入口
- `api`：后端服务，仅内网暴露
- `postgres`：5432，仅内网暴露
- `redis`：6379，仅内网暴露

### 9.2 网络与安全建议
- 使用 Docker 内部网络，数据库不暴露公网端口。
- 最小化 root 远程操作，建议创建部署用户。
- 启用防火墙，仅开放 `22/80/443`。
- 强制 HTTPS，JWT 有效期短 + refresh 机制。
- `.env` 保存密钥（微信密钥、LLM API Key、DB 密码），禁止入库。

## 10. PostgreSQL（Docker）建议参数
- 镜像：`postgres:16`
- 持久化卷：
  - `/opt/research-pilot/postgres/data:/var/lib/postgresql/data`
- 初始化：
  - 创建数据库：`research_pilot`
  - 创建业务用户（非 postgres 超级用户）
- 备份：
  - 每日 `pg_dump` 到本地卷 + 对象存储（COS）可选

## 11. 项目目录建议
```text
miniprogram-7/
  miniprogram/                  # 现有前端
  backend/
    src/
      modules/
        auth/
        user/
        paper/
        ai/
        mission/
        profile/
      common/
      jobs/
    prisma/
      schema.prisma
    Dockerfile
  deploy/
    docker-compose.yml
    nginx.conf
  docs/
    开题.pdf
    后端技术架构规划.md
```

## 12. 里程碑（建议）
- M1：登录 + 用户偏好 + 论文Feed（可联调）
- M2：论文收藏/评论 + 个人中心基础统计
- M3：任务倒排（Mission/Tasks）+ 会议DDL
- M4：AI Lab（总结/润色/Rebuttal）+ 异步队列
- M5：审核、限流、监控、备份

## 13. 下一步可直接执行
- 先落地 `backend` 骨架 + `docker-compose.yml`（含 PostgreSQL/Redis/API/Nginx）。
- 再定义 Prisma Schema（按第7节）并生成第一版迁移。
- 最后与小程序先联调 4 个最小接口：
  - `POST /auth/wx-login`
  - `GET /papers/feed`
  - `POST /papers/:id/action`
  - `GET /profile/dashboard`

## 14. 服务器实测信息（2026-02-18）
- SSH 已连通：`root@111.229.204.242:22`
- 当前已占用端口（监听中）：`22, 25, 80, 888, 8888, 3004, 3306`
- 为避免冲突，建议本项目使用：
  - Nginx 对外：`8081`
  - API 本机映射：`3005 -> 3000`
  - PostgreSQL 本机映射：`5433 -> 5432`（仅 `127.0.0.1`）
  - Redis 本机映射：`6380 -> 6379`（仅 `127.0.0.1`）
